name: NestJS API CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # â”€â”€â”€ Build, lint et tests unitaires â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-and-unit:
    name: Build & Tests Unitaires
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js (depuis .nvmrc)
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: âš¡ Install dependencies
        run: npm ci

      - name: ğŸ” Lint
        run: npm run lint

      - name: ğŸ“¦ Build
        run: npm run build

      - name: ğŸ§ª Tests unitaires
        run: npm test

  # â”€â”€â”€ Tests E2E relationnels via Docker Compose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  e2e-relational:
    name: E2E Tests (PostgreSQL)
    runs-on: ubuntu-latest
    needs: build-and-unit

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“ Lancer les E2E avec Docker Compose
        id: relational
        run: |
          docker compose -f docker-compose.relational.ci.yaml \
                         --env-file env-example-relational \
                         -p ci-relational up --build --exit-code-from api

      - name: Copier prod.log si Ã©chec
        if: ${{ failure() && steps.relational.conclusion == 'failure' }}
        run: docker cp ci-relational-api-1:/usr/src/app/prod.log .

      - name: ğŸ“¤ Upload prod.log (debug)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: prod-logs
          path: prod.log

  # â”€â”€â”€ Code Coverage (optionnel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  coverage:
    name: Publier le coverage
    runs-on: ubuntu-latest
    needs: [ build-and-unit, e2e-relational ]
    steps:
      - uses: actions/checkout@v4

      - name: âš¡ Install dependencies
        run: npm ci

      - name: ğŸ“Š GÃ©nÃ©rer le coverage report
        run: npm run test -- --coverage --coverageReporters=text-junit

      - name: ğŸš€ Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: coverage/junit.xml

